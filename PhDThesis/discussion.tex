\chapter{Discussion and Open Challenges}
Closed-loop medical devices like implantable cardiac devices have both diagnostic and therapeutic capabilities and interact with the patient autonomously in closed-loop. 
Their autonomy makes them among the highest risk devices which require the most stringent regulation. 
Currently, clinical trials are the primary means to identify risks associated with the closed-loop interaction between the devices and the patients. 
While such clinical trials are necessary, they are expensive and ineffective for validation of the safety and efficacy of medical device software. 

Model-based approaches enable closed-loop evaluation throughout the device life-cycle, which require validated physiological models that represent the closed-loop behaviors of different physiological conditions from the device's perspective. 
In this effort, implantable cardiac devices are used as example to demonstrate the application of model-based approaches in providing safety and effectiveness towards ``regulatory grade evidence" of the device and describe how these activities align into the regulatory process. 
A heart model structure that captures the electrical behaviors of the heart was developed.
The model structure was based on clinical electrophysiology, which can be easily interpreted by physicians and its parameters can be identified from patient data.
The model structure was applied in two model-based closed-loop validation applications for implantable cardiac devices.

During device development, the safety and efficacy of a device design can be evaluated using closed-loop model checking.
In closed-loop model checking, the variability of patient conditions is captured by applying over-approximating behaviors of the heart models.
An abstraction tree framework was developed to capture all possible observable behaviors of a human heart from the device perspective, and provide physiological contexts to the counter-examples returned by the model checker.
We demonstrated that closed-loop model checking can effectively identify safety and efficacy violations of device design.

An automated translation tool was developed to translate UPPAAL model to Stateflow chart. 
The rigorous translation together with automated code generation guarantee that properties validated during model checking also hold in the final device implementation.
The complete verified model to verified code toolchain encourages the application of model-based design for other autonomous medical devices.

Before a device is finally evaluated on real patients in clinical trials, in-silico pre-clinical trials can be performed to further increase the confidence of device safety and efficacy.
In in-silico pre-clinical trial, the variability of patient conditions is captured by generating a large number of individual physiological models across a number of physiological conditions. 
This allows us to explore a wider range of heart behaviors and expose more corner cases to isolate software safety issues prior to an actual clinical trial. 
in-silico pre-clinical trials for medical device software have the potential to complement the current regulatory approach by reducing the cost, scope and probability of failure of a traditional clinical trials. 

The area of Medical Cyber-Physical Systems is in its early days with several exciting and urgent fundamental challenges in modeling, control, verification and testing for higher confidence life-critical systems.
Similar model-based approaches used in this dissertation can be potentially applied in other application domains (i.e. autonomous vehicles).
However

%We developed heart models that capture the electrical behaviors across a range of heart conditions, and tailored the heart models for closed-loop model checking and closed-loop testing, which have different requirements. In closed-loop model checking, an abstract model of the pacemaker was validated against physiological requirements. We identified the need for heart models at different abstraction levels and demonstrated an automated approach to select the most appropriate heart model for specific safety requirements. The abstract model of the pacemaker was then automatically translated to Stateflow chart using a model translation tool and then generated into C code implementation. With this model-driven design, we are able to retain the safety properties of the modeled device from verified models to verified code. In closed-loop testing, we use more refined heart models to capture mechanisms that were not captured in the abstract heart models and evaluated pacemaker algorithms. 

%As implantable medical devices grow in sophistication with significant capabilities implemented in software, firmware bugs account for an increasing fraction of device recalls. Since the FDA  does not test, verify or certify the software in such devices, there is an urgent need for a systematic methodology to guarantee the safety of the device software. Furthermore, this safety must account for the closed-loop interaction with the organs of interest. In this effort, we have presented a first step in the direction of a holistic approach for model-based testing and physical patient--device interactive validation. We achieve this through the design of an integrated functional and formal model of the heart and pacemaker device using timed automata. Using this closed-loop system, we conducted formal verification and translate the models to Stateflow for simulation-based testing and then automatically generate code from the verified models. We investigated basic operations, complex algorithms such as response to Pacemaker Mediated Tachycardia and platform-based testing of physical issues such as crosstalk and lead displacement. 

%To validate the environment model, we described an Abstraction Tree approach to select the heart model most appropriate for the specific requirement. This approach separated the evaluation phases where domain knowledge was necessary and where it was not, which simplified the verification of the medical device across a range of heart conditions. The model-based design toolchain from verified models to verified code is conducted within the clinically-relevant context and captures the complexities of interaction with physiological components. 

%This effort describes early steps toward cyber-physical model based testing, validation and verification of medical cyber-physical systems. This is a challenging domain as patient modeling is both complex, highly variable and non-deterministic and the safety properties must include over-approximated models for verification, abstract models for simulation and be realizable in physical form for testing. We aim to extend the current efforts to evaluate more complex devices such as implantable cardioverter defibrillators (ICDs) which are rate-adaptive and operate with varying levels of hysteresis. 

%Eventually we aim to conduct \emph{in-silico Pre-Clinical Trials} with automated approaches to capture and tune patient-specific electrophysiological heart models using data acquired from ablation procedures. 
%By applying parametric and sensitivity analysis to a small sampling of real patient heart models, across a select set of cardiac conditions, to derive a statistically significant, and physiologically relevant, population of patient models. 
%This allows us to explore a wider range of heart behaviors and expose more corner cases to isolate software safety issues prior to an actual clinical trial. 
%Using certified heart models, an in-silico pre-clinical trial provides additional confidence in the closed-loop safety and efficacy of medical devices prior to randomized controlled clinical trials. 
%in-silico pre-clinical trials for medical device software have the potential to complement the current regulatory approach by reducing the cost, scope and probability of failure of a traditional clinical trials. 
%The area of Medical Cyber-Physical Systems is in its early days with several exciting and urgent fundamental challenges in modeling, control, verification and testing for higher confidence life-critical systems.
